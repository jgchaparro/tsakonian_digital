{% extends 'core/base.html' %}

<!-- add block title -->
{% block title %}Μεταφραστής - Tsakonian Digital{% endblock %}

{% block styles %}
  <style>
    body {
      padding-top: 0;
      font-size: 12px;
      color: #777;
      background: #f9f9f9;
      font-family: 'Open Sans',sans-serif;
      margin-top:20px;
    }

    .bg-white {
      background-color: #fff;
    }

    small, .small {
      font-size: 85%;
    }

    .chat-message {
      padding: 60px 20px 115px;
    }

    .chat {
        list-style: none;
        margin: 0;
    }

    .chat-message{
        background: #f9f9f9;  
    }

    .chat li img {
      width: 45px;
      height: 45px;
      border-radius: 50em;
      -moz-border-radius: 50em;
      -webkit-border-radius: 50em;
    }

    img {
      max-width: 100%;
    }

    .chat-body {
      padding-bottom: 20px;
    }

    .chat li.left .chat-body {
      margin-left: 70px;
      background-color: #fff;
    }

    .chat li .chat-body {
      position: relative;
      font-size: 11px;
      padding: 10px;
      border: 1px solid #f1f5fc;
      box-shadow: 0 1px 1px rgba(0,0,0,.05);
      -moz-box-shadow: 0 1px 1px rgba(0,0,0,.05);
      -webkit-box-shadow: 0 1px 1px rgba(0,0,0,.05);
    }

    .chat li .chat-body .header {
      padding-bottom: 5px;
      border-bottom: 1px solid #f1f5fc;
    }

    .chat li .chat-body p {
      margin: 0;
    }

    .chat li.left .chat-body:before {
      position: absolute;
      top: 10px;
      left: -8px;
      display: inline-block;
      background: #fff;
      width: 16px;
      height: 16px;
      border-top: 1px solid #f1f5fc;
      border-left: 1px solid #f1f5fc;
      content: '';
      transform: rotate(-45deg);
      -webkit-transform: rotate(-45deg);
      -moz-transform: rotate(-45deg);
      -ms-transform: rotate(-45deg);
      -o-transform: rotate(-45deg);
    }

    .chat li.right .chat-body:before {
      position: absolute;
      top: 10px;
      right: -8px;
      display: inline-block;
      background: #fff;
      width: 16px;
      height: 16px;
      border-top: 1px solid #f1f5fc;
      border-right: 1px solid #f1f5fc;
      content: '';
      transform: rotate(45deg);
      -webkit-transform: rotate(45deg);
      -moz-transform: rotate(45deg);
      -ms-transform: rotate(45deg);
      -o-transform: rotate(45deg);
    }

    .chat li {
      margin: 15px 0;
    }

    .chat li.right .chat-body {
      margin-right: 70px;
      background-color: #fff;
    }

    .chat-box {
      /* position: fixed;
      bottom: 0;
      margin-left: 70px;
      left: relative;
      right: relative; */
      padding: 15px;
      border-top: 1px solid #eee;
      transition: all .5s ease;
      -webkit-transition: all .5s ease;
      -moz-transition: all .5s ease;
      -ms-transition: all .5s ease;
      -o-transition: all .5s ease;
    }

    .primary-font {
      color: #3c8dbc;
    }

    a:hover, a:active, a:focus {
      text-decoration: none;
      outline: 0;
    }
  </style>
{% endblock %}


{% block content %}

<!-- header to the chat -->
<div class="container bootstrap snippets bootdey">
  <div class="row">
      <!--=========================================================-->
      <!-- selected chat -->
    <div class="col-md-12 bg-white "><h3>Τσακώνικος μεταφραστής</h3></div>
    <div class="col-md-12 bg-white ">
          <div class="chat-message">
              <ul class="chat messages-list">
                  <li class="message received left clearfix">
                    <span class="chat-img pull-left">
                      <img src="https://bootdey.com/img/Content/user_3.jpg" alt="User Avatar">
                    </span>
                    <div class="message-text chat-body clearfix">
                      <div class="header message-sender">
                        <strong class="primary-font">Λεώνιδα</strong>
                        <!-- <small class="pull-right text-muted"><i class="fa fa-clock-o"></i> 12 mins ago</small> -->
                      </div>
                      <div class="message-content">
                        <p>Γεια! Ένι ο Λεώνιδα.</p>
                      </div>
                    </div>
                  </li>          
              </ul>
          </div>
          <form class="message-form">
            {% csrf_token %}
            <div class="chat-box bg-white">
              <div class="input-group">
                <input type="text" class="form-control message-input border no-shadow no-rounded" placeholder="Type your message here">
                <span class="input-group-btn">
                  <button class="btn btn-primary btn-send" type="submit">Αποστολή</button>
                </span>
              </div><!-- /input-group -->	
            </div>
          </form>       
  </div>        
</div>
</div>

{% endblock %}

{% block scripts %}
<script>
  const messageForm = document.querySelector('.message-form');
  const messageInput = document.querySelector('.message-input');
  const messagesList = document.querySelector('.messages-list');


  messageForm.addEventListener('submit', async event => {
    event.preventDefault();
    const message = messageInput.value.trim();
    if (message.length === 0) {
      return;
    }
    const messageItem = document.createElement('li');
    messageItem.classList.add('message', 'sent', 'right', 'clearfix');
    messageItem.innerHTML = `
      <span class="chat-img pull-right">
        <img src="https://bootdey.com/img/Content/user_1.jpg" alt="User Avatar">
      </span>
      <div class="message-text chat-body clearfix">
        <div class="header message-sender">
          <strong class="primary-font">You</strong>
        </div>
        <div class="message-content">
          <p>${message}</p>
        </div>
      </div>
    `;
    messagesList.appendChild(messageItem);

    messageInput.value = ''; // Clear input

    messagesList.lastElementChild.scrollIntoView(); // Scroll to the bottom

    const to_translate = "Translate the following sentence from Spanish to Tsakonian: " + message;

    try {
      const response = await fetch('https://g3gtpfycldxi0pt0.us-east-1.aws.endpoints.huggingface.cloud/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer Málaga'
        },
        body: JSON.stringify({
          model: "tgi",
          messages: [
            {
              role: "user",
              content: to_translate
            }
          ],
          temperature: 0  
        })
      });

        const data = await response.json();
        const translatedMessage = data.choices[0].message.content.replace('Translation to Tsakonian: ', '');
    
        // Send message to server
        const receivedMessageItem = document.createElement('li');
        receivedMessageItem.classList.add('message', 'received', 'left', 'clearfix');
        receivedMessageItem.innerHTML = `
          <span class="chat-img pull-left">
            <img src="https://bootdey.com/img/Content/user_3.jpg" alt="User Avatar">
          </span>
          <div class="message-text chat-body clearfix">
            <div class="header message-sender">
              <strong class="primary-font">Λεώνιδα</strong>
              <!-- <small class="pull-right text-muted"><i class="fa fa-clock-o"></i> 12 mins ago</small> -->
            </div>
            <div class="message-content">
              <p>${translatedMessage}</p>
            </div>
          </div>
        `;
        messagesList.appendChild(receivedMessageItem);
        messagesList.lastElementChild.scrollIntoView(); // Scroll to the bottom
      } catch (error) {
        console.error('Error:', error);
      }
    });

</script>
{% endblock %}
